#!/usr/bin/env ruby

require_relative "../config/env"
require "drawing_visitors"
require "engine"
require "failing_fetcher"
require "gosu_box_renderer"
require "gosu_text_renderer"
require "gui_window"
require "image_store"
require "layout_visitors"
require "offline_html_fetcher"
require "parser"

# "Usage: echo '<html></html>' | #{$0}"

html = STDIN.read

LOGGER = ->(message) { puts(message) }

offline_image_store = ->(image_dimensions_calculator:) {
  ImageStore.new(
    fetcher: FailingFetcher.new,
    image_dimensions_calculator: image_dimensions_calculator,
  )
}

browser = GuiWindow.new(
  engine: Engine.new(
    fetcher: OfflineHtmlFetcher.new(html),
    image_store_factory: offline_image_store,
    layout_pipeline: LAYOUT_VISITORS,
    parser: Parser.new,
  ),
  drawing_visitors: DRAWING_VISITORS,
)

browser.address = "offline"
browser.go

browser.show
